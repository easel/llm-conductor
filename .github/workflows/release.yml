name: Release & Publish

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Distribution
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for version calculation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Build package
        run: uv build

      - name: Verify build
        run: |
          ls -lh dist/
          echo "Built packages:"
          ls -1 dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 90

  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Extract release notes
        id: release_notes
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG" >> $GITHUB_OUTPUT

          # Create release notes
          cat > release_notes.md << EOF
          ## llm-conductor $TAG

          ### Installation

          \`\`\`bash
          # From PyPI
          pip install llm-conductor==${TAG#v}

          # From GitHub Pages index
          pip install llm-conductor==${TAG#v} --index-url https://easel.github.io/llm-conductor/simple/

          # With observability support
          pip install llm-conductor[observability]==${TAG#v}
          \`\`\`

          ### What's Changed

          See [CHANGELOG](https://github.com/easel/llm-conductor/blob/main/CHANGELOG.md) for details.

          ### Artifacts

          - Source distribution (sdist): \`llm-conductor-${TAG#v}.tar.gz\`
          - Wheel distribution: \`llm_conductor-${TAG#v}-py3-none-any.whl\`
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.release_notes.outputs.tag, 'rc') || contains(steps.release_notes.outputs.tag, 'alpha') || contains(steps.release_notes.outputs.tag, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # publish-pypi:
  #   name: Publish to PyPI
  #   needs: build
  #   runs-on: ubuntu-latest
  #   environment:
  #     name: pypi
  #     url: https://pypi.org/project/llm-conductor/
  #   permissions:
  #     id-token: write  # IMPORTANT: mandatory for trusted publishing
  #   steps:
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: dist
  #         path: dist/
  #
  #     - name: Publish to PyPI
  #       uses: pypa/gh-action-pypi-publish@release/v1
  #       with:
  #         # Uses trusted publishing (no token needed if configured)
  #         # To use API token instead, add PYPI_TOKEN secret and uncomment:
  #         # password: ${{ secrets.PYPI_TOKEN }}
  #         print-hash: true
  #         verbose: true

  build-index:
    name: Build PyPI Index for GitHub Pages
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Generate PyPI-compatible index
        run: |
          mkdir -p pages/simple/llm-conductor

          # Create root index.html
          cat > pages/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>LLM Conductor - Private PyPI Repository</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 40px; }
              h1 { color: #0366d6; }
              code { background: #f6f8fa; padding: 2px 6px; border-radius: 3px; }
              pre { background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; }
              .container { max-width: 800px; margin: 0 auto; }
              .badge { display: inline-block; padding: 4px 8px; background: #0366d6; color: white; border-radius: 3px; font-size: 12px; margin: 4px; }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ðŸŽµ LLM Conductor</h1>
              <p><span class="badge">Python 3.12</span> <span class="badge">Apache 2.0</span></p>
              <p>Unified LLM provider orchestration with batch processing and streaming support.</p>

              <h2>Installation</h2>
              <pre>pip install llm-conductor --index-url https://easel.github.io/llm-conductor/simple/</pre>

              <h2>Quick Start</h2>
              <pre>
          # Single prompt
          echo "Explain Python decorators" | llm-conductor run --provider openai

          # Batch processing
          llm-conductor batch --provider openai --input-dir prompts/ --output-dir outputs/
              </pre>

              <h2>Available Packages</h2>
              <ul>
                <li><a href="simple/llm-conductor/">llm-conductor</a></li>
              </ul>

              <h2>Links</h2>
              <ul>
                <li><a href="https://github.com/easel/llm-conductor">GitHub Repository</a></li>
                <li><a href="https://pypi.org/project/llm-conductor/">PyPI (Official)</a></li>
              </ul>
            </div>
          </body>
          </html>
          EOF

          # Create simple/index.html (PEP 503)
          cat > pages/simple/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Simple Index</title></head>
          <body>
            <h1>Simple Index</h1>
            <a href="llm-conductor/">llm-conductor</a><br/>
          </body>
          </html>
          EOF

          # Create package index with all versions
          cat > pages/simple/llm-conductor/index.html << 'PKGEOF'
          <!DOCTYPE html>
          <html>
          <head><title>Links for llm-conductor</title></head>
          <body>
            <h1>Links for llm-conductor</h1>
          PKGEOF

          # Add links to all distribution files
          for file in dist/*; do
            filename=$(basename "$file")
            # Calculate SHA256 hash
            hash=$(sha256sum "$file" | cut -d' ' -f1)
            echo "    <a href=\"../../../releases/download/${GITHUB_REF#refs/tags/}/$filename#sha256=$hash\">$filename</a><br/>" >> pages/simple/llm-conductor/index.html
          done

          # Close HTML
          cat >> pages/simple/llm-conductor/index.html << 'PKGEOF'
          </body>
          </html>
          PKGEOF

          # Create .nojekyll to disable Jekyll processing
          touch pages/.nojekyll

          echo "Generated index structure:"
          find pages -type f -exec echo "  {}" \;

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages/

  deploy-pages:
    name: Deploy to GitHub Pages
    needs: build-index
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  verify:
    name: Verify Release
    needs: [release, deploy-pages]
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Wait for PyPI propagation
        run: sleep 60

      # - name: Verify PyPI installation
      #   run: |
      #     TAG=${GITHUB_REF#refs/tags/}
      #     VERSION=${TAG#v}
      #
      #     # Try installing from PyPI
      #     pip install llm-conductor==$VERSION || echo "PyPI installation pending (may take a few minutes to propagate)"
      #
      #     # Verify version
      #     pip show llm-conductor || true

      - name: Verify GitHub Pages installation
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}

          # Try installing from GitHub Pages index
          pip install --index-url https://easel.github.io/llm-conductor/simple/ llm-conductor==$VERSION || echo "GitHub Pages index not yet available"

      - name: Summary
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          cat << EOF
          âœ… Release $TAG complete!

          ðŸ“„ GitHub Pages: https://easel.github.io/llm-conductor/
          ðŸ·ï¸  GitHub Release: https://github.com/easel/llm-conductor/releases/tag/$TAG
          EOF
